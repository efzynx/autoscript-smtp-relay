<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMTP Relay - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --success-color: #4cc9f0;
            --danger-color: #f72585;
            --warning-color: #f8961e;
        }
        body { background-color: #f5f7fb; font-family: 'Segoe UI', sans-serif; }
        .dashboard-header { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 25px 0; margin-bottom: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .card { border-radius: 12px; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; transition: transform 0.3s, box-shadow 0.3s; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .card-header { background-color: white; border-bottom: 1px solid rgba(0,0,0,0.05); padding: 18px 20px; font-weight: 600; color: var(--primary-color); }
        .stat-card { text-align: center; padding: 20px; }
        .stat-card .icon { font-size: 2.5rem; margin-bottom: 15px; }
        .stat-card .number { font-size: 2rem; font-weight: 700; }
        .queue-content { background-color: #f8f9fa; padding: 15px; border-radius: 8px; font-family: monospace; max-height: 300px; overflow-y: auto; white-space: pre-wrap; }
        footer { text-align: center; margin-top: 40px; color: #6c757d; font-size: 0.9rem; }
        .modal-header { border-bottom: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="dashboard-header text-center">
            <h1><i class="bi bi-envelope-check"></i> SMTP Relay Dashboard</h1>
            <p class="lead">Manage your email relay configurations with ease</p>
        </div>
        
        <!-- Stats Row -->
        <div class="row">
            <div class="col-md-3"><div class="card stat-card"><div class="icon text-primary"><i class="bi bi-people"></i></div><div class="number" id="senders-count">0</div><div>Senders</div></div></div>
            <div class="col-md-3"><div class="card stat-card"><div class="icon text-success"><i class="bi bi-check-circle"></i></div><div class="number" id="status-postfix">?</div><div>Postfix Status</div></div></div>
            <div class="col-md-3"><div class="card stat-card"><div class="icon text-warning"><i class="bi bi-envelope"></i></div><div class="number" id="queue-count">0</div><div>In Queue</div></div></div>
            <div class="col-md-3"><div class="card stat-card"><div class="icon text-info"><i class="bi bi-gear"></i></div><div class="number">10+</div><div>Features</div></div></div>
        </div>

        <div id="message-container"></div>
        
        <!-- Main Content -->
        <div class="row">
            <div class="col-lg-5">
                <!-- Send Test Email -->
                <div class="card">
                    <div class="card-header"><i class="bi bi-send"></i> Send Test Email</div>
                    <div class="card-body">
                        <form id="test-email-form">
                            <div class="mb-3"><label for="from_email" class="form-label">From Email</label><select class="form-select" id="from_email" required><option value="">Select sender</option></select></div>
                            <div class="mb-3"><label for="to_email" class="form-label">To Email</label><input type="email" class="form-control" id="to_email" required></div>
                            <div class="mb-3"><label for="subject" class="form-label">Subject</label><input type="text" class="form-control" id="subject" required></div>
                            <div class="mb-3"><label for="body" class="form-label">Message</label><textarea class="form-control" id="body" rows="4" required></textarea></div>
                            <button type="submit" class="btn btn-primary w-100"><i class="bi bi-send-fill"></i> Send</button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-lg-7">
                <!-- Senders List -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-people"></i> Senders</span>
                        <div>
                            <span class="badge bg-primary rounded-pill me-2" id="senders-badge">0</span>
                            <button class="btn btn-sm btn-primary" id="add-sender-btn">
                                <i class="bi bi-plus-circle"></i> Add New
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0" id="senders-list-container"><div id="senders-list"></div></div>
                </div>
                <!-- SASL card -->
                <div class="card">
                    <div class="card-header"><i class="bi bi-shield-lock"></i> Konfigurasi SASL (SMTP Relay)</div>
                    <div class="card-body">
                        <form id="sasl-form">
                            <div class="row mb-3">
                                <div class="col-8">
                                    <label for="relay_host" class="form-label">Relay Host</label>
                                    <input type="text" class="form-control" id="relay_host" placeholder="smtp.example.com" required>
                                </div>
                                <div class="col-4">
                                    <label for="relay_port" class="form-label">Port</label>
                                    <input type="number" class="form-control" id="relay_port" value="587" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="username" class="form-label">Username</label>
                                <input type="text" class="form-control" id="username" placeholder="user@example.com" required>
                            </div>
                            <div class="mb-3">
                                <label for="password" class="form-label">Password</label>
                                <input type="password" class="form-control" id="password" required>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Simpan Konfigurasi SASL</button>
                        </form>
                    </div>
                </div>
                <!-- Mail Queue -->
                <div class="card">
                    <div class="card-header"><i class="bi bi-inboxes"></i> Mail Queue</div>
                    <div class="card-body">
                        <div class="queue-content" id="queue-info">Loading...</div>
                        <div class="mt-3 text-end"><button id="flush-queue-btn" class="btn btn-warning"><i class="bi bi-bootstrap-reboot"></i> Flush Queue</button></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Sender Modal -->
    <div class="modal fade" id="addSenderModal" tabindex="-1" aria-labelledby="addSenderModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addSenderModalLabel"><i class="bi bi-person-plus"></i> Add New Sender</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="add-sender-modal-form">
              <div class="mb-3">
                <label for="add-sender-name" class="form-label">Name</label>
                <input type="text" class="form-control" id="add-sender-name" required>
              </div>
              <div class="mb-3">
                <label for="add-sender-email" class="form-label">Email</label>
                <input type="email" class="form-control" id="add-sender-email" required>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" id="save-new-sender">Save Sender</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Sender Modal -->
    <div class="modal fade" id="editSenderModal" tabindex="-1" aria-labelledby="editSenderModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editSenderModalLabel"><i class="bi bi-pencil-square"></i> Edit Sender</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="edit-sender-form">
              <input type="hidden" id="edit-sender-id">
              <div class="mb-3">
                <label for="edit-sender-name" class="form-label">Name</label>
                <input type="text" class="form-control" id="edit-sender-name" required>
              </div>
              <div class="mb-3">
                <label for="edit-sender-email" class="form-label">Email</label>
                <input type="email" class="form-control" id="edit-sender-email" required>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" id="save-sender-changes">Save changes</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE_URL = '/api';
        let editSenderModal;
        let addSenderModal;

        document.addEventListener('DOMContentLoaded', function() {
            addSenderModal = new bootstrap.Modal(document.getElementById('addSenderModal'));
            editSenderModal = new bootstrap.Modal(document.getElementById('editSenderModal'));
            
            loadAllData();
            
            document.getElementById('add-sender-btn').addEventListener('click', openAddModal);
            document.getElementById('save-new-sender').addEventListener('click', addSender);
            document.getElementById('sasl-form').addEventListener('submit', handleSaslForm);
            document.getElementById('test-email-form').addEventListener('submit', sendTestEmail);
            document.getElementById('flush-queue-btn').addEventListener('click', flushQueue);
            document.getElementById('save-sender-changes').addEventListener('click', saveSenderChanges);
        });

        function loadAllData() {
            loadStatus();
            loadSenders();
            loadQueue();
        }

        async function apiFetch(endpoint, options = {}) {
            try {
                const response = await fetch(API_BASE_URL + endpoint, options);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'Network error or invalid JSON response' }));
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }
                // Jika tidak ada konten, kembalikan objek sukses kosong
                const text = await response.text();
                return text ? JSON.parse(text) : { status: 'success' };
            } catch (error) {
                console.error('API Fetch Error:', error);
                showMessage('API Error: ' + error.message, 'error');
                throw error;
            }
        }

        async function loadStatus() {
            try {
                const data = await apiFetch('/status');
                document.getElementById('senders-count').textContent = data.senders_count;
                document.getElementById('senders-badge').textContent = data.senders_count;
                const postfixStatusEl = document.getElementById('status-postfix');
                if (data.postfix_running) {
                    postfixStatusEl.innerHTML = '<i class="bi bi-check-circle-fill text-success"></i>';
                } else {
                    postfixStatusEl.innerHTML = '<i class="bi bi-x-circle-fill text-danger"></i>';
                }
            } catch(e) { /* Error sudah ditangani di apiFetch */ }
        }

        async function loadSenders() {
            try {
                const senders = await apiFetch('/senders');
                const select = document.getElementById('from_email');
                select.innerHTML = '<option value="">Select sender</option>';
                senders.forEach(sender => {
                    const option = document.createElement('option');
                    option.value = sender.email;
                    option.textContent = sender.name + ' <' + sender.email + '>';
                    select.appendChild(option);
                });

                const sendersList = document.getElementById('senders-list');
                if (senders.length === 0) {
                    sendersList.innerHTML = '<div class="text-center p-4"><i class="bi bi-people fs-1 text-muted"></i><p class="text-muted mt-2">No senders configured yet</p></div>';
                    return;
                }
                let html = '<ul class="list-group list-group-flush">';
                senders.forEach((sender, index) => {
                    html += '<li class="list-group-item d-flex justify-content-between align-items-center">' +
                        '<div><strong>' + sender.name + '</strong><br><small class="text-muted">' + sender.email + '</small></div>' +
                        '<div>' +
                        '<button class="btn btn-sm btn-outline-primary me-2" onclick="openEditModal(' + index + ', \'' + sender.name.replace(/'/g, "\\'") + '\', \'' + sender.email + '\')"><i class="bi bi-pencil"></i></button>' +
                        '<button class="btn btn-sm btn-outline-danger" onclick="deleteSender(' + index + ')"><i class="bi bi-trash"></i></button>' +
                        '</div>' +
                        '</li>';
                });
                html += '</ul>';
                sendersList.innerHTML = html;
            } catch(e) { /* Error sudah ditangani di apiFetch */ }
        }

        async function loadQueue() {
            try {
                const data = await apiFetch('/mail_queue');
                document.getElementById('queue-info').textContent = data.queue || data.message;
                const lines = data.queue ? data.queue.split('\n') : [];
                const count = lines.filter(line => line.trim() && !line.includes('Mail queue is empty') && !line.includes('-Queue ID-')).length;
                document.getElementById('queue-count').textContent = count;
            } catch(e) { /* Error sudah ditangani di apiFetch */ }
        }

        function openAddModal() {
            document.getElementById('add-sender-modal-form').reset();
            addSenderModal.show();
        }

        async function addSender() {
            try {
                const data = {
                    name: document.getElementById('add-sender-name').value,
                    email: document.getElementById('add-sender-email').value
                };
                if (!data.name || !data.email) {
                    showMessage('Name and Email are required.', 'error');
                    return;
                }
                await apiFetch('/senders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                showMessage('Sender added successfully!', 'success');
                addSenderModal.hide();
                loadAllData();
            } catch(e) { /* Error sudah ditangani di apiFetch */ }
        }
        
        async function sendTestEmail(e) {
            e.preventDefault();
            try {
                const fromSelect = document.getElementById('from_email');
                const data = {
                    from_email: fromSelect.value,
                    from_name: fromSelect.options[fromSelect.selectedIndex].text.split('<')[0].trim(),
                    to_email: document.getElementById('to_email').value,
                    subject: document.getElementById('subject').value,
                    body: document.getElementById('body').value
                };
                await apiFetch('/send_test_email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                showMessage('Test email sent successfully!', 'success');
                document.getElementById('test-email-form').reset();
                setTimeout(loadQueue, 1500); // Beri waktu Postfix
            } catch(e) { /* Error sudah ditangani di apiFetch */ }
        }

        async function flushQueue() {
            if (!confirm('Are you sure you want to flush the mail queue?')) return;
            try {
                const data = await apiFetch('/flush_queue', { method: 'POST' });
                showMessage(data.message || 'Flush command sent!', data.status === 'success' ? 'info' : 'error');
                setTimeout(loadAllData, 1500);
            } catch(e) { /* Error sudah ditangani di apiFetch */ }
        }

        async function deleteSender(index) {
            if (!confirm('Are you sure you want to delete this sender?')) return;
            try {
                await apiFetch('/senders/' + index, { method: 'DELETE' });
                showMessage('Sender deleted successfully!', 'success');
                loadAllData();
            } catch(e) { /* Error sudah ditangani di apiFetch */ }
        }

        function openEditModal(id, name, email) {
            document.getElementById('edit-sender-id').value = id;
            document.getElementById('edit-sender-name').value = name;
            document.getElementById('edit-sender-email').value = email;
            editSenderModal.show();
        }

        async function saveSenderChanges() {
            try {
                const id = document.getElementById('edit-sender-id').value;
                const data = {
                    name: document.getElementById('edit-sender-name').value,
                    email: document.getElementById('edit-sender-email').value
                };
                await apiFetch('/senders/' + id, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                showMessage('Sender updated successfully!', 'success');
                editSenderModal.hide();
                loadAllData();
            } catch(e) { /* Error sudah ditangani di apiFetch */ }
        }
        
        function showMessage(message, type) {
            const container = document.getElementById('message-container');
            const bsClass = type === 'success' ? 'alert-success' : (type === 'error' ? 'alert-danger' : 'alert-info');
            
            const alertHtml = 
                '<div class="alert ' + bsClass + ' alert-dismissible fade show" role="alert">' +
                message +
                '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                '</div>';

            container.innerHTML = alertHtml;
            
            setTimeout(() => {
                const alert = container.querySelector('.alert');
                if (alert) {
                    bootstrap.Alert.getOrCreateInstance(alert).close();
                }
            }, 5000);
        }

        async function handleSaslForm(e) {
            e.preventDefault();
            try {
                // PERUBAHAN: Ambil nilai dari dua input
                const data = {
                    relay_host: document.getElementById('relay_host').value,
                    relay_port: parseInt(document.getElementById('relay_port').value, 10),
                    username: document.getElementById('username').value,
                    password: document.getElementById('password').value,
                };
                if (!data.relay_host || !data.relay_port || !data.username) {
                    showMessage('All SASL fields are required.', 'error');
                    return;
                }

                const result = await apiFetch('/configure_sasl', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                showMessage(result.message || 'SASL configuration saved!', 'success');
                // Jangan reset form agar mudah diedit kembali
            } catch (e) { /* Error sudah ditangani di apiFetch */ }
        }
    </script>
</body>
</html>

